<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Secure Chat</title>
    <style>
        /* --- ç™½é»’ã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        body { margin: 0; font-family: sans-serif; height: 100vh; background: #fff; color: #000; display: flex; overflow: hidden; }
        
        /* ãƒœã‚¿ãƒ³å…±é€š */
        button { background: #000; color: #fff; border: 1px solid #000; padding: 8px 16px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        button:hover { background: #333; }
        button.secondary { background: #fff; color: #000; }
        input { padding: 10px; border: 1px solid #000; outline: none; box-sizing: border-box; }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-screen { position: fixed; inset: 0; background: #fff; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { width: 300px; display: flex; flex-direction: column; gap: 15px; }
        
        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ */
        #main-screen { display: none; width: 100%; height: 100%; }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar { width: 280px; border-right: 1px solid #000; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; height: 60px; box-sizing: border-box; }
        .user-info { font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }
        .icon-btn { cursor: pointer; font-size: 1.2rem; position: relative; padding: 5px; }
        
        /* é€šçŸ¥ãƒãƒƒã‚¸ */
        .badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }
        .badge.active { display: block; }

        .friend-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .friend-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .friend-item:hover { background: #f0f0f0; }
        .friend-item.active { background: #000; color: #fff; }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; border-bottom: 1px solid #000; height: 60px; display: flex; align-items: center; font-weight: bold; box-sizing: border-box; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* å¹ãå‡ºã— */
        .msg { display: flex; flex-direction: column; max-width: 70%; }
        .msg.sent { align-self: flex-end; align-items: flex-end; }
        .msg.received { align-self: flex-start; align-items: flex-start; }
        .bubble { padding: 10px 15px; border: 1px solid #000; line-height: 1.4; word-break: break-all; }
        .sent .bubble { background: #000; color: #fff; }
        .received .bubble { background: #fff; color: #000; }
        .read-mark { font-size: 0.7rem; color: #888; margin-top: 2px; visibility: hidden; }
        .read-mark.visible { visibility: visible; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area { padding: 15px; border-top: 1px solid #000; display: flex; gap: 10px; visibility: hidden; }
        .input-area input { flex: 1; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé€šçŸ¥ãƒ»è¨­å®šãªã©ï¼‰ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { border: 2px solid #000; background: #fff; padding: 30px; width: 350px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 20px; border-bottom: 1px solid #000; padding-bottom: 10px; }
        .request-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .req-buttons { display: flex; gap: 5px; justify-content: flex-end; }
        .close-btn { margin-top: 20px; width: 100%; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="margin-bottom: 20px;">LOGIN / SIGNUP</h2>
        <div class="login-box">
            <input type="text" id="login-id" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆåŠè§’è‹±æ•°ï¼‰">
            <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button onclick="authLogin()">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</button>
            <p style="font-size: 0.8rem; color: #666;">â€»IDãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•ã§æ–°è¦ç™»éŒ²ã•ã‚Œã¾ã™</p>
        </div>
    </div>

    <div id="main-screen">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <span id="my-display-name">MyName</span>
                    <span class="icon-btn" onclick="openSettings()">âš™ï¸</span>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="icon-btn" onclick="openNotifications()">
                        ğŸ””<div class="badge" id="notif-badge"></div>
                    </div>
                    <div class="icon-btn" onclick="openAddFriend()">â•</div>
                </div>
            </div>
            <ul class="friend-list" id="friend-list"></ul>
        </div>

        <div class="chat-area">
            <div class="chat-header" id="chat-header">ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ã‚’é¸æŠ</div>
            <div class="messages" id="messages-container"></div>
            <div class="input-area" id="input-area">
                <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
                <button onclick="sendMessage()">é€ä¿¡</button>
            </div>
        </div>
    </div>

    <div id="modal-add-friend" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">å‹é”ã‚’æ¢ã™</div>
            <input type="text" id="search-id" placeholder="ç›¸æ‰‹ã®IDã‚’å…¥åŠ›" style="width: 100%; margin-bottom: 15px;">
            <button onclick="sendFriendRequest()" style="width: 100%;">ç”³è«‹ã‚’é€ã‚‹</button>
            <button class="secondary close-btn" onclick="closeModal('modal-add-friend')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="modal-notifications" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">å±Šã„ã¦ã„ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
            <div id="request-list"></div>
            <button class="secondary close-btn" onclick="closeModal('modal-notifications')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">è¨­å®š</div>
            <label style="font-size: 0.8rem; font-weight: bold;">è¡¨ç¤ºåã®å¤‰æ›´</label>
            <input type="text" id="new-display-name" style="width: 100%; margin: 5px 0 15px;">
            <button onclick="updateProfile()" style="width: 100%;">å¤‰æ›´ã‚’ä¿å­˜</button>
            <button class="secondary close-btn" onclick="closeModal('modal-settings')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, updateDoc, doc, getDocs, setDoc, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…â˜…â˜… ã“ã“ã«ã‚ãªãŸã®firebaseConfigã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyBa8kgwcvMk3IoKaIbMlrRVVz1EHupvcsE",
            authDomain: "simple-chat-fa8cb.firebaseapp.com",
            projectId: "simple-chat-fa8cb",
            storageBucket: "simple-chat-fa8cb.firebasestorage.app",
            messagingSenderId: "180077807120",
            appId: "1:180077807120:web:97cc9cfa9735955ce22c95",
            measurementId: "G-L1PTP1MSYQ"
        };
        // â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”¨
        let myId = "";      // ãƒ­ã‚°ã‚¤ãƒ³ID
        let myName = "";    // è¡¨ç¤ºå
        let currentChatPartner = "";
        let allMessages = [];

        // --------------------------------------------------
        // 1. ãƒ­ã‚°ã‚¤ãƒ³ & æ–°è¦ç™»éŒ²æ©Ÿèƒ½
        // --------------------------------------------------
        window.authLogin = async () => {
            const idInput = document.getElementById('login-id').value.trim();
            const passInput = document.getElementById('login-pass').value.trim();

            if (!idInput || !passInput) return alert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            const userRef = doc(db, "users", idInput);
            const userSnap = await getDocs(query(collection(db, "users"), where("__name__", "==", idInput)));

            if (!userSnap.empty) {
                // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
                const userData = userSnap.docs[0].data();
                if (userData.password === passInput) {
                    loginSuccess(idInput, userData.displayName);
                } else {
                    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                }
            } else {
                // --- æ–°è¦ç™»éŒ²å‡¦ç† ---
                if(confirm(`ID: ${idInput} ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    await setDoc(userRef, {
                        username: idInput,
                        password: passInput,
                        displayName: idInput, // æœ€åˆã¯IDã¨åŒã˜
                        friends: []
                    });
                    loginSuccess(idInput, idInput);
                }
            }
        };

        function loginSuccess(id, name) {
            myId = id;
            myName = name;
            document.getElementById('my-display-name').textContent = myName;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            
            // å„ç¨®ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ
            listenFriends();
            listenRequests();
            listenMessages();
        }

        // --------------------------------------------------
        // 2. å‹é”ç”³è«‹ã‚·ã‚¹ãƒ†ãƒ 
        // --------------------------------------------------
        window.openAddFriend = () => document.getElementById('modal-add-friend').style.display = 'flex';
        
        window.sendFriendRequest = async () => {
            const targetId = document.getElementById('search-id').value.trim();
            if(!targetId) return;
            if(targetId === myId) return alert("è‡ªåˆ†ã«ã¯é€ã‚Œã¾ã›ã‚“");

            // ç›¸æ‰‹ãŒå­˜åœ¨ã™ã‚‹ã‹
            const targetSnap = await getDocs(query(collection(db, "users"), where("__name__", "==", targetId)));
            if(targetSnap.empty) return alert("ãã®IDã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

            // ã™ã§ã«ç”³è«‹æ¸ˆã¿ã‹ç¢ºèª
            const q = query(collection(db, "requests"), 
                where("from", "==", myId), where("to", "==", targetId), where("status", "==", "pending"));
            const existing = await getDocs(q);
            if(!existing.empty) return alert("ã™ã§ã«ç”³è«‹ä¸­ã§ã™");

            // ç”³è«‹é€ä¿¡
            await addDoc(collection(db, "requests"), {
                from: myId,
                to: targetId,
                status: "pending",
                timestamp: new Date().getTime()
            });
            alert("ç”³è«‹ã‚’é€ã‚Šã¾ã—ãŸï¼ç›¸æ‰‹ã®æ‰¿èªã‚’å¾…ã£ã¦ãã ã•ã„");
            closeModal('modal-add-friend');
        };

        // é€šçŸ¥å—ä¿¡ï¼ˆãƒ™ãƒ«ãƒãƒ¼ã‚¯ï¼‰
        function listenRequests() {
            const q = query(collection(db, "requests"), where("to", "==", myId), where("status", "==", "pending"));
            onSnapshot(q, (snapshot) => {
                const badge = document.getElementById('notif-badge');
                const list = document.getElementById('request-list');
                list.innerHTML = "";

                if (snapshot.empty) {
                    badge.classList.remove('active');
                    list.innerHTML = "<p>æ–°ã—ã„é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
                } else {
                    badge.classList.add('active');
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = "request-item";
                        div.innerHTML = `
                            <div><strong>${data.from}</strong> ã‹ã‚‰å‹é”ç”³è«‹</div>
                            <div class="req-buttons">
                                <button onclick="answerRequest('${doc.id}', '${data.from}', true)">æ‰¿èª</button>
                                <button class="secondary" onclick="answerRequest('${doc.id}', '${data.from}', false)">æ‹’å¦</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
            });
        }

        window.openNotifications = () => document.getElementById('modal-notifications').style.display = 'flex';

        // æ‰¿èªãƒ»æ‹’å¦å‡¦ç†
        window.answerRequest = async (reqId, targetId, isAccept) => {
            const batch = writeBatch(db);
            const reqRef = doc(db, "requests", reqId);

            if (isAccept) {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                batch.update(reqRef, { status: "accepted" });
                
                // ãŠäº’ã„ã®å‹é”ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆusersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®é…åˆ—ï¼‰
                const myRef = doc(db, "users", myId);
                const targetRef = doc(db, "users", targetId);
                
                batch.update(myRef, { friends: arrayUnion(targetId) });
                batch.update(targetRef, { friends: arrayUnion(myId) });

                await batch.commit();
                alert(`${targetId} ã¨å‹é”ã«ãªã‚Šã¾ã—ãŸï¼`);
            } else {
                batch.update(reqRef, { status: "rejected" });
                await batch.commit();
            }
        };

        // --------------------------------------------------
        // 3. å‹é”ãƒªã‚¹ãƒˆ & è¨­å®š
        // --------------------------------------------------
        function listenFriends() {
            onSnapshot(doc(db, "users", myId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // åå‰ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰åæ˜ 
                    if(data.displayName) {
                        myName = data.displayName;
                        document.getElementById('my-display-name').textContent = myName;
                    }

                    // å‹é”ãƒªã‚¹ãƒˆæç”»
                    const ul = document.getElementById('friend-list');
                    ul.innerHTML = "";
                    const friends = data.friends || [];
                    
                    if(friends.length === 0) {
                        ul.innerHTML = "<li style='padding:20px; color:#999; text-align:center;'>å‹é”ãŒã„ã¾ã›ã‚“<br>â•ãƒœã‚¿ãƒ³ã§è¿½åŠ ã—ã‚ˆã†</li>";
                    }

                    friends.forEach(fId => {
                        const li = document.createElement('li');
                        li.className = `friend-item ${fId === currentChatPartner ? 'active' : ''}`;
                        li.innerHTML = `<span>${fId}</span>`;
                        li.onclick = () => selectFriend(fId);
                        ul.appendChild(li);
                    });
                }
            });
        }

        // è¨­å®šï¼ˆåå‰å¤‰æ›´ï¼‰
        window.openSettings = () => {
            document.getElementById('new-display-name').value = myName;
            document.getElementById('modal-settings').style.display = 'flex';
        };

        window.updateProfile = async () => {
            const newName = document.getElementById('new-display-name').value.trim();
            if(!newName) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            await updateDoc(doc(db, "users", myId), { displayName: newName });
            alert("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
            closeModal('modal-settings');
        };

        // --------------------------------------------------
        // 4. ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆåŸºæœ¬ã¯å‰å›ã¨åŒã˜ï¼‰
        // --------------------------------------------------
        function selectFriend(fId) {
            currentChatPartner = fId;
            document.getElementById('chat-header').innerText = fId + " ã¨ãƒãƒ£ãƒƒãƒˆä¸­";
            document.getElementById('input-area').style.visibility = 'visible';
            
            // é¸æŠçŠ¶æ…‹ã®æ›´æ–°
            const items = document.querySelectorAll('.friend-item');
            items.forEach(i => {
                if(i.textContent === fId) i.classList.add('active');
                else i.classList.remove('active');
            });

            renderMessages();
            markAsRead(fId);
        }

        function listenMessages() {
            const q = query(collection(db, "messages"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                allMessages = [];
                snapshot.forEach(d => allMessages.push({ id: d.id, ...d.data() }));
                
                if (currentChatPartner) {
                    renderMessages();
                    markAsRead(currentChatPartner);
                }
            });
        }

        function renderMessages() {
            if(!currentChatPartner) return;
            const container = document.getElementById('messages-container');
            container.innerHTML = "";

            const chatLog = allMessages.filter(m => 
                (m.from === myId && m.to === currentChatPartner) ||
                (m.from === currentChatPartner && m.to === myId)
            );

            chatLog.forEach(m => {
                const isMe = m.from === myId;
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                
                let html = `<div class="bubble">${m.text}</div>`;
                if(isMe) html += `<div class="read-mark ${m.isRead ? 'visible' : ''}">æ—¢èª­</div>`;
                
                div.innerHTML = html;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentChatPartner) return;

            await addDoc(collection(db, "messages"), {
                from: myId, to: currentChatPartner, text: text,
                timestamp: new Date().getTime(), isRead: false
            });
            input.value = "";
        };

        async function markAsRead(targetId) {
            const batch = writeBatch(db);
            let hasUpdate = false;
            allMessages.forEach(m => {
                if(m.from === targetId && m.to === myId && m.isRead === false) {
                    const ref = doc(db, "messages", m.id);
                    batch.update(ref, { isRead: true });
                    hasUpdate = true;
                }
            });
            if(hasUpdate) await batch.commit();
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    </script>
</body>
</html>
